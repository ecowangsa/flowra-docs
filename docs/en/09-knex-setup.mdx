---
id: knex-setup
slug: /data/knex-setup
sidebar_position: 9
---

# Knex Configuration

## Overview
Flowra uses Knex as the primary SQL query builder. Configuration lives in `core/knex` and reads from environment variables defined in `.env`. The CLI ships with `orm.cli.config.js` so migrations and seeds run with the same settings as the runtime application.

## Configuration file
`core/knex/connection.factory.ts` exports a factory that maps environments:

```ts
import knex, {Knex} from 'knex';
import {config} from '../config/config.service';

export function createConnection(): Knex {
  return knex({
    client: config.get('database.client'),
    connection: {
      host: config.get('database.host'),
      port: config.get('database.port'),
      user: config.get('database.user'),
      password: config.get('database.password'),
      database: config.get('database.name'),
    },
    pool: {
      min: config.get('database.poolMin', 2),
      max: config.get('database.poolMax', 10),
    },
    migrations: {
      directory: 'database/migrations',
      tableName: 'migrations',
    },
  });
}
```

Environment-aware values are defined under `config/database.ts`:

```ts
export default {
  client: process.env.DB_CONNECTION ?? 'pg',
  host: process.env.DB_HOST ?? '127.0.0.1',
  port: Number(process.env.DB_PORT ?? 5432),
  user: process.env.DB_USER ?? 'postgres',
  password: process.env.DB_PASSWORD ?? 'secret',
  name: process.env.DB_DATABASE ?? 'flowra',
  poolMin: Number(process.env.DB_POOL_MIN ?? 2),
  poolMax: Number(process.env.DB_POOL_MAX ?? 10),
};
```

## `.env` example
```
DB_CONNECTION=pg
DB_HOST=127.0.0.1
DB_PORT=5432
DB_USER=postgres
DB_PASSWORD=secret
DB_DATABASE=flowra
DB_POOL_MIN=2
DB_POOL_MAX=10
```

## Multiple connections
If you need multiple databases, add named configurations under `config/database.ts` and register them in the container:

```ts
export default {
  default: 'primary',
  connections: {
    primary: { /* ... */ },
    analytics: { /* ... */ },
  },
};
```

Then register factories:

```ts
container.singleton('Database.primary', () => createConnection('primary'));
container.singleton('Database.analytics', () => createConnection('analytics'));
```

Use the correct connection inside services:

```ts
@injectable()
export class ReportService {
  constructor(@inject('Database.analytics') private readonly db: Knex) {}
}
```

## CLI integration
`orm.cli.config.js` loads the same config and exposes commands:

```js
module.exports = {
  config: './core/knex/knexfile.js',
  migrations: {
    directory: 'database/migrations',
    stub: 'core/knex/stubs/migration.stub',
  },
  seeds: {
    directory: 'database/seeds',
  },
};
```

Run migrations:

```bash
npx flowra migrate
npx flowra migrate:rollback
npx flowra seed
```

> **note**
> For CI pipelines, set `DB_MIGRATE=true` to automatically run migrations during `flowra serve`.
