---
id: request-lifecycle
slug: /architecture/request-lifecycle
sidebar_position: 5
---

# HTTP Request Lifecycle

## High-level journey
Every HTTP request travels through a predictable pipeline built on top of Express and Flowra's service container.

```
Client → HTTP Server → Middleware Stack → Router → Controller → Service → Model → Response
```

## Step-by-step
1. **HTTP bootstrap** – `main/bootstrap.ts` loads environment variables, builds the container, and resolves `core/http/kernel.ts`.
2. **Server start** – `kernel.ts` configures Express, attaches global middlewares (compression, body parsing, CORS), and registers routes exposed by modules.
3. **Incoming request** – Express receives the request and hands it to the middleware queue defined in `core/http/middleware`.
4. **Middleware processing** – Middlewares can short-circuit (e.g., authentication) or enrich the request (e.g., attach `requestId`). They obtain dependencies from the container via the `@injectable` decorator.
5. **Routing** – `core/http/router.ts` matches the path and method against registered module routes.
6. **Controller invocation** – Controllers (e.g., `app/modules/users/http/controllers/users.controller.ts`) receive the `Request`/`Response` pair and orchestrate validation and services.
7. **Service execution** – Services resolve their dependencies through constructor injection (repositories, message queues, other services) and execute business logic.
8. **Model/data access** – Services talk to Knex models in `app/modules/<context>/models` or `core/knex` helpers. Transactions can be managed via the `DatabaseManager` exported from `core/knex/connection.factory.ts`.
9. **Response mapping** – Controllers return value objects. `core/http/responses/json-response.ts` serialises them, while exceptions bubble to `core/http/responses/error-handler.ts` which maps known errors to HTTP status codes.

## ASCII diagram
```
+-----------+      +---------------+      +----------------+      +-----------------+
| HTTP Req  | ---> | Express Layer | ---> | Middleware Bus | ---> | Route Resolver  |
+-----------+      +---------------+      +----------------+      +-----------------+
                                                                       |
                                                                       v
                                                           +-----------------------+
                                                           | Controller (Module)   |
                                                           +-----------------------+
                                                                       |
                                                                       v
                                                           +-----------------------+
                                                           | Service (DI scoped)   |
                                                           +-----------------------+
                                                                       |
                                                                       v
                                                           +-----------------------+
                                                           | Model / Repository    |
                                                           +-----------------------+
                                                                       |
                                                                       v
                                                           +-----------------------+
                                                           | HTTP Response Builder |
                                                           +-----------------------+
```

## Extensibility points
- **Global middlewares** – add files under `core/http/middleware` and register them in `kernel.ts`.
- **Module middlewares** – export a `middlewares` array from `app/modules/<context>/index.ts` to scope them per module.
- **Exception filters** – extend `core/http/exceptions/http-exception.ts` to map domain errors to HTTP responses.
- **Lifecycle events** – emit and listen to events through `core/events` to decouple auditing, metrics, or asynchronous jobs.

## Debugging tips
> **tip**
> Enable the request profiler by toggling `HTTP_DEBUG=true` in `.env`. It prints the middleware and controller chain with execution times.

- Log the resolved dependencies from services to verify container wiring.
- Wrap suspect sections in `DatabaseManager.transaction()` to ensure queries roll back during experiments.
- Use the testing utilities in `core/testing/application-test-module.ts` to reproduce request flows in isolation.
