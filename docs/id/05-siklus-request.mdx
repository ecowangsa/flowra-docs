---
id: request-lifecycle
slug: /architecture/request-lifecycle
sidebar_position: 5
---

# Siklus Request HTTP

## Perjalanan tingkat tinggi
Setiap request HTTP melewati pipeline yang dapat diprediksi di atas Express dan service container milik Flowra.

```
Client → HTTP Server → Middleware Stack → Router → Controller → Service → Model → Response
```

## Langkah demi langkah
1. **Bootstrap HTTP** – `main/bootstrap.ts` memuat variabel environment, membangun container, dan me-resolve `core/http/kernel.ts`.
2. **Menyalakan server** – `kernel.ts` mengonfigurasi Express, memasang middleware global (compression, body parsing, CORS), dan mendaftarkan route milik modul.
3. **Request masuk** – Express menerima request lalu meneruskannya ke antrian middleware yang didefinisikan di `core/http/middleware`.
4. **Proses middleware** – Middleware bisa menghentikan alur (mis. autentikasi) atau memperkaya request (mis. menambah `requestId`). Mereka mengambil dependensi dari container melalui dekorator `@injectable`.
5. **Routing** – `core/http/router.ts` mencocokkan path dan method dengan route yang terdaftar.
6. **Pemanggilan controller** – Controller (misal `app/modules/users/http/controllers/users.controller.ts`) menerima pasangan `Request`/`Response` dan mengorkestrasi validasi serta service.
7. **Eksekusi service** – Service me-resolve dependensi melalui constructor injection (repository, message queue, service lain) dan menjalankan logika bisnis.
8. **Model/akses data** – Service berkomunikasi dengan model Knex di `app/modules/<context>/models` atau helper `core/knex`. Transaksi dapat dikelola memakai `DatabaseManager` dari `core/knex/connection.factory.ts`.
9. **Pemetaan respons** – Controller mengembalikan value object. `core/http/responses/json-response.ts` melakukan serialisasi, sementara exception mengalir ke `core/http/responses/error-handler.ts` yang memetakan error dikenal menjadi status HTTP.

## Diagram ASCII
```
+-----------+      +---------------+      +----------------+      +-----------------+
| HTTP Req  | ---> | Express Layer | ---> | Middleware Bus | ---> | Route Resolver  |
+-----------+      +---------------+      +----------------+      +-----------------+
                                                                       |
                                                                       v
                                                           +-----------------------+
                                                           | Controller (Module)   |
                                                           +-----------------------+
                                                                       |
                                                                       v
                                                           +-----------------------+
                                                           | Service (DI scoped)   |
                                                           +-----------------------+
                                                                       |
                                                                       v
                                                           +-----------------------+
                                                           | Model / Repository    |
                                                           +-----------------------+
                                                                       |
                                                                       v
                                                           +-----------------------+
                                                           | HTTP Response Builder |
                                                           +-----------------------+
```

## Titik ekstensi
- **Middleware global** – tambahkan berkas di `core/http/middleware` dan daftarkan di `kernel.ts`.
- **Middleware modul** – ekspor array `middlewares` dari `app/modules/<context>/index.ts` untuk cakupan per modul.
- **Exception filter** – turunkan `core/http/exceptions/http-exception.ts` agar error domain terpetakan ke respons HTTP.
- **Lifecycle events** – emit dan dengarkan event melalui `core/events` guna memisahkan audit, metrik, atau job asynchronous.

## Tips debugging
> **tip**
> Aktifkan profiler request dengan mengubah `HTTP_DEBUG=true` pada `.env`. Output akan menampilkan rantai middleware dan controller beserta durasi.

- Log dependensi yang di-resolve dari service untuk memastikan wiring container benar.
- Bungkus bagian yang dicurigai dengan `DatabaseManager.transaction()` supaya query bisa rollback saat eksperimen.
- Gunakan utilitas testing di `core/testing/application-test-module.ts` untuk mereproduksi alur request secara terisolasi.
