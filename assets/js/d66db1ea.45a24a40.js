"use strict";(globalThis.webpackChunkflowra_docs=globalThis.webpackChunkflowra_docs||[]).push([[562],{1904:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>d,contentTitle:()=>l,default:()=>u,frontMatter:()=>t,metadata:()=>r,toc:()=>o});const r=JSON.parse('{"id":"data/models-and-queries","title":"Models & Queries","description":"Use Flowra models and query classes to encapsulate database access.","source":"@site/docs/data/models-and-queries.mdx","sourceDirName":"data","slug":"/data/models-and-queries","permalink":"/docs/data/models-and-queries","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"title":"Models & Queries","description":"Use Flowra models and query classes to encapsulate database access."},"sidebar":"docsSidebar","previous":{"title":"Database Configuration","permalink":"/docs/data/knex-configuration"},"next":{"title":"Migrations & Seeds","permalink":"/docs/data/migrations-and-seeds"}}');var a=n(4848),i=n(8453);const t={title:"Models & Queries",description:"Use Flowra models and query classes to encapsulate database access."},l=void 0,d={},o=[{value:"The Model base class",id:"the-model-base-class",level:2},{value:"Service helpers",id:"service-helpers",level:2},{value:"Query Builder (Knex)",id:"query-builder-knex",level:2},{value:"Read queries",id:"read-queries",level:3},{value:"Joins and aggregates",id:"joins-and-aggregates",level:3},{value:"Writes and transactions",id:"writes-and-transactions",level:3},{value:"Query classes",id:"query-classes",level:2},{value:"Wiring models and queries",id:"wiring-models-and-queries",level:2}];function c(e){const s={admonition:"admonition",code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(s.p,{children:["Flowra models extend the ",(0,a.jsx)(s.code,{children:"Service"})," base class, which wraps Knex and provides helpers for reads, writes, and timestamps."]}),"\n",(0,a.jsx)(s.h2,{id:"the-model-base-class",children:"The Model base class"}),"\n",(0,a.jsxs)(s.p,{children:[(0,a.jsx)(s.code,{children:"app/Config/Model.js"})," extends ",(0,a.jsx)(s.code,{children:"Service"})," and provides defaults like table name, primary key, and allowed fields."]}),"\n",(0,a.jsx)(s.pre,{children:(0,a.jsx)(s.code,{className:"language-js",metastring:'title="app/Modules/Users/Users.model.js"',children:"const Model = require('../../Config/Model');\n\nclass UsersModel extends Model {\n  constructor(connection = 'default') {\n    super(connection);\n    this.setTable('users');\n    this.setPrimaryKey('id');\n    this.setAllowedFields(['id', 'username', 'email', 'password']);\n    this.setTimestamps(true);\n    this.setSoftDelete(false);\n  }\n\n  async findAll() {\n    return this.read().select('*').whereNull('deletedAt');\n  }\n}\n\nmodule.exports = UsersModel;\n"})}),"\n",(0,a.jsx)(s.h2,{id:"service-helpers",children:"Service helpers"}),"\n",(0,a.jsxs)(s.p,{children:[(0,a.jsx)(s.code,{children:"Service"})," provides:"]}),"\n",(0,a.jsxs)(s.ul,{children:["\n",(0,a.jsxs)(s.li,{children:[(0,a.jsx)(s.code,{children:"read()"})," and ",(0,a.jsx)(s.code,{children:"write()"})," to build queries"]}),"\n",(0,a.jsxs)(s.li,{children:[(0,a.jsx)(s.code,{children:"save()"})," and ",(0,a.jsx)(s.code,{children:"saveBulk()"})," for inserts"]}),"\n",(0,a.jsxs)(s.li,{children:[(0,a.jsx)(s.code,{children:"update()"})," and ",(0,a.jsx)(s.code,{children:"delete()"})," for mutations"]}),"\n",(0,a.jsxs)(s.li,{children:[(0,a.jsx)(s.code,{children:"readKnex()"})," to use a read replica when available"]}),"\n"]}),"\n",(0,a.jsx)(s.h2,{id:"query-builder-knex",children:"Query Builder (Knex)"}),"\n",(0,a.jsxs)(s.p,{children:["Flowra\u2019s ",(0,a.jsx)(s.strong,{children:"Query Builder"})," is the Knex query builder that you access through ",(0,a.jsx)(s.code,{children:"read()"})," and ",(0,a.jsx)(s.code,{children:"write()"}),". This means you can use the full Knex API while keeping connection aliases consistent."]}),"\n",(0,a.jsxs)(s.p,{children:["Because Flowra models already set ",(0,a.jsx)(s.code,{children:"this.tableName"}),", you do ",(0,a.jsx)(s.strong,{children:"not"})," need to call ",(0,a.jsx)(s.code,{children:".from('table')"})," for the current model unless you are joining or selecting across multiple tables."]}),"\n",(0,a.jsx)(s.h3,{id:"read-queries",children:"Read queries"}),"\n",(0,a.jsxs)(s.p,{children:["Use ",(0,a.jsx)(s.code,{children:"read()"})," for selects and reporting:"]}),"\n",(0,a.jsx)(s.pre,{children:(0,a.jsx)(s.code,{className:"language-js",metastring:'title="app/Modules/Users/Users.model.js"',children:"getAll({ search, limit = 25, offset = 0 } = {}) {\n  const query = this.read()\n    .select('id', 'name', 'email', 'createdAt')\n    .orderBy('createdAt', 'desc')\n    .limit(limit)\n    .offset(offset);\n\n  if (search) {\n    query.where((builder) => {\n      builder\n        .where('email', 'like', `%${search}%`)\n        .orWhere('name', 'like', `%${search}%`);\n    });\n  }\n\n  return query;\n}\n\ngetSingle(id) {\n  return this.read()\n    .select('id', 'name', 'email', 'createdAt')\n    .where({ id })\n    .first();\n}\n"})}),"\n",(0,a.jsx)(s.h3,{id:"joins-and-aggregates",children:"Joins and aggregates"}),"\n",(0,a.jsx)(s.p,{children:"Knex supports joins and aggregates for richer reads:"}),"\n",(0,a.jsx)(s.pre,{children:(0,a.jsx)(s.code,{className:"language-js",metastring:'title="app/Modules/Users/Users.model.js"',children:"getUsersWithTeams() {\n  return this.read()\n    .select('users.id', 'users.name', 'teams.name as teamName')\n    .leftJoin('teams', 'teams.id', 'users.teamId')\n    .orderBy('users.name', 'asc');\n}\n"})}),"\n",(0,a.jsx)(s.h3,{id:"writes-and-transactions",children:"Writes and transactions"}),"\n",(0,a.jsxs)(s.p,{children:["Use ",(0,a.jsx)(s.code,{children:"write()"})," when you need to mutate data. Wrap complex changes in a transaction:"]}),"\n",(0,a.jsx)(s.pre,{children:(0,a.jsx)(s.code,{className:"language-js",metastring:'title="app/Modules/Users/Users.model.js"',children:"async updateProfile(id, payload) {\n  const trx = await this.write().transaction();\n\n  try {\n    await this.write().transacting(trx).update(payload).where({ id });\n    await trx.commit();\n    return this.getSingle(id);\n  } catch (error) {\n    await trx.rollback();\n    throw error;\n  }\n}\n"})}),"\n",(0,a.jsx)(s.p,{children:"Because the Query Builder is Knex, you can reuse familiar Knex patterns without leaving the Flowra model layer."}),"\n",(0,a.jsx)(s.h2,{id:"query-classes",children:"Query classes"}),"\n",(0,a.jsx)(s.p,{children:"Queries are lightweight classes for specific read operations:"}),"\n",(0,a.jsx)(s.pre,{children:(0,a.jsx)(s.code,{className:"language-js",metastring:'title="app/Modules/Welcome/SystemInfo.query.js"',children:"class SystemInfoQuery {\n  async execute() {\n    return {\n      environment: process.env.NODE_ENV || 'development',\n      nodeVersion: process.version,\n      uptime: process.uptime(),\n    };\n  }\n}\n\nmodule.exports = SystemInfoQuery;\n"})}),"\n",(0,a.jsx)(s.h2,{id:"wiring-models-and-queries",children:"Wiring models and queries"}),"\n",(0,a.jsx)(s.p,{children:"Register models and queries in the module container:"}),"\n",(0,a.jsx)(s.pre,{children:(0,a.jsx)(s.code,{className:"language-js",metastring:'title="app/Modules/Users/users.container.js"',children:"const { asClass } = require('awilix');\nconst UsersModel = require('./Users.model');\n\nmodule.exports = (scope) => {\n  scope.register({\n    models: {\n      user: asClass(UsersModel).singleton(),\n    },\n  });\n};\n"})}),"\n",(0,a.jsx)(s.admonition,{title:"Keep reads and writes clean",type:"tip",children:(0,a.jsx)(s.p,{children:"Use query classes for reporting and services for business logic. This keeps your code intentional and testable."})})]})}function u(e={}){const{wrapper:s}={...(0,i.R)(),...e.components};return s?(0,a.jsx)(s,{...e,children:(0,a.jsx)(c,{...e})}):c(e)}},8453:(e,s,n)=>{n.d(s,{R:()=>t,x:()=>l});var r=n(6540);const a={},i=r.createContext(a);function t(e){const s=r.useContext(i);return r.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function l(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:t(e.components),r.createElement(i.Provider,{value:s},e.children)}}}]);