"use strict";(globalThis.webpackChunkflowra_docs=globalThis.webpackChunkflowra_docs||[]).push([[792],{6183:(e,r,n)=>{n.r(r),n.d(r,{assets:()=>a,contentTitle:()=>i,default:()=>c,frontMatter:()=>l,metadata:()=>t,toc:()=>d});const t=JSON.parse('{"id":"examples/jwt-multer","title":"JWT Auth + File Uploads","description":"Add JWT login/registration and a Multer-powered upload endpoint in Flowra.","source":"@site/docs/examples/jwt-multer.mdx","sourceDirName":"examples","slug":"/examples/jwt-multer","permalink":"/docs/examples/jwt-multer","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"title":"JWT Auth + File Uploads","description":"Add JWT login/registration and a Multer-powered upload endpoint in Flowra."},"sidebar":"docsSidebar","previous":{"title":"Example: Users API","permalink":"/docs/examples/users-api"},"next":{"title":"Contributing","permalink":"/docs/community/contributing"}}');var s=n(4848),o=n(8453);const l={title:"JWT Auth + File Uploads",description:"Add JWT login/registration and a Multer-powered upload endpoint in Flowra."},i=void 0,a={},d=[{value:"1. Install dependencies",id:"1-install-dependencies",level:2},{value:"2. Configure JWT secret",id:"2-configure-jwt-secret",level:2},{value:"3. Auth service (JWT + bcrypt)",id:"3-auth-service-jwt--bcrypt",level:2},{value:"4. Auth controller with validation",id:"4-auth-controller-with-validation",level:2},{value:"5. JWT middleware",id:"5-jwt-middleware",level:2},{value:"6. Upload controller (Multer)",id:"6-upload-controller-multer",level:2},{value:"7. Routes + container wiring",id:"7-routes--container-wiring",level:2},{value:"8. Try it with curl",id:"8-try-it-with-curl",level:2}];function u(e){const r={admonition:"admonition",code:"code",h2:"h2",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(r.p,{children:["This example extends the Users module with ",(0,s.jsx)(r.strong,{children:"JWT authentication"})," and a ",(0,s.jsx)(r.strong,{children:"Multer upload"})," endpoint. It assumes you already have the ",(0,s.jsx)(r.code,{children:"users"})," table from the Build Your First API guide."]}),"\n",(0,s.jsx)(r.h2,{id:"1-install-dependencies",children:"1. Install dependencies"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-bash",children:"npm install jsonwebtoken bcrypt multer\n"})}),"\n",(0,s.jsx)(r.h2,{id:"2-configure-jwt-secret",children:"2. Configure JWT secret"}),"\n",(0,s.jsx)(r.p,{children:"Add a secret to your environment:"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-bash",children:"JWT_SECRET=super-secret-value\n"})}),"\n",(0,s.jsx)(r.h2,{id:"3-auth-service-jwt--bcrypt",children:"3. Auth service (JWT + bcrypt)"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-js",metastring:'title="app/Modules/Users/Auth.service.js"',children:"const HttpError = require('../../Errors/HttpError');\nconst jwt = require('jsonwebtoken');\nconst bcrypt = require('bcrypt');\n\nclass AuthService {\n  constructor({ models } = {}) {\n    this.usersModel = models.user;\n  }\n\n  async register(payload) {\n    const passwordHash = await bcrypt.hash(payload.password, 10);\n    const id = await this.usersModel.save({\n      name: payload.name,\n      email: payload.email,\n      password_hash: passwordHash,\n    });\n    return this.usersModel.getSingle(id);\n  }\n\n  async login({ email, password }) {\n    const user = await this.usersModel.findByEmail(email);\n    if (!user) {\n      throw new HttpError(401, 'Invalid credentials');\n    }\n\n    const valid = await bcrypt.compare(password, user.password_hash);\n    if (!valid) {\n      throw new HttpError(401, 'Invalid credentials');\n    }\n\n    const token = jwt.sign(\n      { id: user.id, email: user.email },\n      process.env.JWT_SECRET,\n      { expiresIn: '2h' }\n    );\n\n    return { token, user: { id: user.id, name: user.name, email: user.email } };\n  }\n}\n\nmodule.exports = AuthService;\n"})}),"\n",(0,s.jsx)(r.h2,{id:"4-auth-controller-with-validation",children:"4. Auth controller with validation"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-js",metastring:'title="app/Modules/Users/Auth.controller.js"',children:"const HttpError = require('../../Errors/HttpError');\n\nclass AuthController {\n  constructor({ services, validationFactory } = {}) {\n    this.authService = services.auth;\n    this.validationFactory = validationFactory;\n  }\n\n  get registerRules() {\n    return {\n      name: { required: true },\n      email: { required: true, is_email: true },\n      password: { required: true, minLength: 8 },\n    };\n  }\n\n  get loginRules() {\n    return {\n      email: { required: true, is_email: true },\n      password: { required: true },\n    };\n  }\n\n  async register(req, res) {\n    const validator = this.validationFactory(this.registerRules);\n    const errors = await validator.validate(req.body);\n    if (errors.length > 0) {\n      throw new HttpError(422, 'Validation failed', errors);\n    }\n\n    const user = await this.authService.register(req.body);\n    return res.status(201).json(user);\n  }\n\n  async login(req, res) {\n    const validator = this.validationFactory(this.loginRules);\n    const errors = await validator.validate(req.body);\n    if (errors.length > 0) {\n      throw new HttpError(422, 'Validation failed', errors);\n    }\n\n    const result = await this.authService.login(req.body);\n    return res.json(result);\n  }\n}\n\nmodule.exports = AuthController;\n"})}),"\n",(0,s.jsx)(r.h2,{id:"5-jwt-middleware",children:"5. JWT middleware"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-js",metastring:'title="app/Middleware/auth.middleware.js"',children:"const jwt = require('jsonwebtoken');\nconst HttpError = require('../Errors/HttpError');\n\nmodule.exports = function authMiddleware(req, _res, next) {\n  const header = req.headers.authorization || '';\n  const token = header.replace('Bearer ', '').trim();\n\n  if (!token) {\n    return next(new HttpError(401, 'Missing auth token'));\n  }\n\n  try {\n    req.user = jwt.verify(token, process.env.JWT_SECRET);\n    return next();\n  } catch (error) {\n    return next(new HttpError(401, 'Invalid auth token'));\n  }\n};\n"})}),"\n",(0,s.jsx)(r.h2,{id:"6-upload-controller-multer",children:"6. Upload controller (Multer)"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-js",metastring:'title="app/Modules/Users/Uploads.controller.js"',children:"class UploadsController {\n  async create(req, res) {\n    return res.status(201).json({\n      file: {\n        originalName: req.file.originalname,\n        mimeType: req.file.mimetype,\n        size: req.file.size,\n        path: req.file.path,\n      },\n    });\n  }\n}\n\nmodule.exports = UploadsController;\n"})}),"\n",(0,s.jsx)(r.h2,{id:"7-routes--container-wiring",children:"7. Routes + container wiring"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-js",metastring:'title="app/Modules/Users/users.routes.js"',children:"const multer = require('multer');\nconst authMiddleware = require('../../Middleware/auth.middleware');\n\nconst upload = multer({ dest: 'storage/uploads' });\n\nfunction registerUsersRoutes({ router, container } = {}) {\n  if (!router || !container) {\n    return router;\n  }\n\n  const authController = container.resolve('modules.users.controllers.auth');\n  const uploadsController = container.resolve('modules.users.controllers.uploads');\n\n  router.post('/auth/register', authController.register.bind(authController));\n  router.post('/auth/login', authController.login.bind(authController));\n\n  router.post(\n    '/uploads',\n    authMiddleware,\n    upload.single('file'),\n    uploadsController.create.bind(uploadsController)\n  );\n\n  return router;\n}\n\nmodule.exports = registerUsersRoutes;\n"})}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-js",metastring:'title="app/Modules/Users/users.container.js"',children:"const { asClass, asValue } = require('awilix');\nconst AuthService = require('./Auth.service');\nconst AuthController = require('./Auth.controller');\nconst UploadsController = require('./Uploads.controller');\nconst registerUsersRoutes = require('./users.routes');\n\nmodule.exports = (scope) => {\n  scope.register({\n    services: {\n      auth: asClass(AuthService).singleton(),\n    },\n    controllers: {\n      auth: asClass(AuthController).singleton(),\n      uploads: asClass(UploadsController).singleton(),\n    },\n    routes: asValue(registerUsersRoutes),\n  });\n};\n"})}),"\n",(0,s.jsx)(r.h2,{id:"8-try-it-with-curl",children:"8. Try it with curl"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-bash",children:'# Register\ncurl -X POST http://localhost:3387/auth/register \\\n  -H \'Content-Type: application/json\' \\\n  -d \'{"name":"Rani","email":"rani@flowra.dev","password":"secret123"}\'\n\n# Login\ncurl -X POST http://localhost:3387/auth/login \\\n  -H \'Content-Type: application/json\' \\\n  -d \'{"email":"rani@flowra.dev","password":"secret123"}\'\n\n# Upload (replace TOKEN)\ncurl -X POST http://localhost:3387/uploads \\\n  -H \'Authorization: Bearer TOKEN\' \\\n  -F \'file=@/path/to/avatar.png\'\n'})}),"\n",(0,s.jsx)(r.admonition,{title:"Notes",type:"tip",children:(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsxs)(r.li,{children:["Create the folder ",(0,s.jsx)(r.code,{children:"storage/uploads"})," before testing uploads."]}),"\n",(0,s.jsx)(r.li,{children:"For production, use a storage provider (S3, GCS) instead of local disk."}),"\n"]})})]})}function c(e={}){const{wrapper:r}={...(0,o.R)(),...e.components};return r?(0,s.jsx)(r,{...e,children:(0,s.jsx)(u,{...e})}):u(e)}},8453:(e,r,n)=>{n.d(r,{R:()=>l,x:()=>i});var t=n(6540);const s={},o=t.createContext(s);function l(e){const r=t.useContext(o);return t.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function i(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:l(e.components),t.createElement(o.Provider,{value:r},e.children)}}}]);